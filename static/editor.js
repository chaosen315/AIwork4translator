// static/editor.js (root copy)
/* copied from webui_project/static/editor.js */
let originalEditor, translationEditor;
let originalFilePath = '';
let translationFilePath = '';
let pollingInterval = null;
let isTranslationComplete = false;
let userScrolled = false;
let refreshTimeout = null;
function refreshEditors(){ if (refreshTimeout) clearTimeout(refreshTimeout); refreshTimeout = setTimeout(()=>{ if (originalEditor && originalEditor.codemirror) originalEditor.codemirror.refresh(); if (translationEditor && translationEditor.codemirror) translationEditor.codemirror.refresh(); },50);} 
function getUrlParameters(){ const params={}; const queryString=window.location.search; const urlParams=new URLSearchParams(queryString); for (const [key,value] of urlParams){ params[key]=value; } return params; }
function initEditors(){ originalEditor=new SimpleMDE({ element: document.getElementById('originalEditor'), toolbar:false, status:false, spellChecker:false, readOnly:true, placeholder:'加载原文内容...' }); translationEditor=new SimpleMDE({ element: document.getElementById('translationEditor'), spellChecker:false, placeholder:'等待翻译结果...' }); translationEditor.codemirror.on('scroll',()=>{ userScrolled=true; setTimeout(()=>{ userScrolled=false; },3000); }); refreshEditors(); }
async function loadOriginalContent(){ if (window.templateParams && window.templateParams.md_path){ originalFilePath = window.templateParams.md_path; } else { const params = getUrlParameters(); if (params.md_path){ originalFilePath = params.md_path; } else { try { const response = await fetch('/get-latest-cache'); const data = await response.json(); if (data.status === 'success' && data.md_path){ originalFilePath = data.md_path; } } catch (error) { console.error('获取最新缓存失败:', error); } } } if (originalFilePath){ try { const response = await fetch(`/load-content?file_path=${encodeURIComponent(originalFilePath)}`); const data = await response.json(); if (data.status === 'success'){ originalEditor.value(data.content); refreshEditors(); originalEditor.codemirror.scrollTo(0,0); } else { alert('加载原文失败: ' + data.message); } } catch (error){ console.error('加载原文错误:', error); alert('加载原文失败'); } } }
function initResizer(){ const resizer=document.querySelector('.editor-resizer'); const leftColumn=resizer.previousElementSibling; const rightColumn=resizer.nextElementSibling; const container=document.querySelector('.editor-container'); const resizerWidth=5; let isResizing=false; resizer.addEventListener('mousedown',()=>{ isResizing=true; document.body.style.cursor='col-resize'; }); document.addEventListener('mousemove',(e)=>{ if(!isResizing) return; const containerRect=container.getBoundingClientRect(); const containerWidth=containerRect.width; let leftWidth=e.clientX - containerRect.left - (resizerWidth/2); let rightWidth=containerWidth - leftWidth - resizerWidth; if (leftWidth>=200 && rightWidth>=200){ leftColumn.style.flex = `0 0 ${leftWidth}px`; rightColumn.style.flex = `0 0 ${rightWidth}px`; resizer.style.flex = `0 0 ${resizerWidth}px`; } }); document.addEventListener('mouseup',()=>{ isResizing=false; document.body.style.cursor=''; refreshEditors(); }); }
async function startTranslation(){ const params=getUrlParameters(); try { document.getElementById('translationProgress').parentElement.style.display='block'; document.getElementById('statusIndicator').style.display='block'; document.getElementById('statusText').textContent='翻译进行中...'; document.getElementById('startTranslationBtn').disabled=true; document.getElementById('startTranslationBtn').innerHTML='<i class="bi bi-hourglass-split"></i> 翻译中...'; document.getElementById('translationCompleteAlert').classList.add('d-none'); isTranslationComplete=false; const formData=new FormData(); formData.append('cache_key', params.cache_key || '0'); const response=await fetch('/start-translation', { method:'POST', body: formData }); const data=await response.json(); if (data.status === 'success'){ window.currentTranslationTaskId = data.task_id; translationFilePath = data.output_file; startPolling(); } else { throw new Error(data.message || '翻译启动失败'); } } catch (error){ console.error('翻译错误:', error); alert('翻译失败: ' + error.message); resetTranslationUI(); } }
function startPolling(){ if (pollingInterval){ clearInterval(pollingInterval); } updateTranslationProgress(); pollingInterval = setInterval(updateTranslationProgress, 500); }
async function updateTranslationProgress(){ if (isTranslationComplete || !window.currentTranslationTaskId){ clearInterval(pollingInterval); return; } try { const response = await fetch(`/translation-progress?task_id=${encodeURIComponent(window.currentTranslationTaskId)}`); const data = await response.json(); const progressBar = document.getElementById('translationProgress').querySelector('.progress-bar'); progressBar.style.width = `${data.progress}%`; progressBar.setAttribute('aria-valuenow', data.progress); document.getElementById('progressText').textContent = `${data.current_paragraph}/${data.total_paragraphs}`; if (data.content){ const currentContent = translationEditor.value(); if (data.content !== currentContent){ translationEditor.value(data.content); if (!userScrolled){ translationEditor.codemirror.scrollIntoView(translationEditor.codemirror.lineCount()); } refreshEditors(); } } if (data.status === 'completed'){ isTranslationComplete = true; clearInterval(pollingInterval); document.getElementById('statusText').textContent = '翻译完成'; document.getElementById('translationCompleteAlert').classList.remove('d-none'); document.getElementById('translationCompleteAlert').style.display = 'flex'; document.body.classList.add('has-complete-alert'); document.getElementById('downloadBtn').onclick = () => { window.location.href = `/download?task_id=${encodeURIComponent(window.currentTranslationTaskId)}`; }; resetTranslationUI(); } else if (data.status === 'error'){ clearInterval(pollingInterval); alert('翻译出错: ' + data.message); document.getElementById('statusText').textContent = '翻译出错'; resetTranslationUI(); } } catch (error){ console.error('更新进度错误:', error); } }
function resetTranslationUI(){ document.getElementById('startTranslationBtn').disabled=false; document.getElementById('startTranslationBtn').innerHTML='<i class="bi bi-translate"></i> 开始翻译'; const progressContainer=document.querySelector('.progress-container'); if (progressContainer){ progressContainer.style.display='none'; } }
function openFile(filePath){ window.open(`/open-file?file_path=${encodeURIComponent(filePath)}`, '_blank'); }
function setupAutoSave(){ let lastSavedContent=''; setInterval(()=>{ if (isTranslationComplete){ const currentContent=translationEditor.value(); if (currentContent !== lastSavedContent){ saveContent(); lastSavedContent = currentContent; } } }, 20000); }
async function saveContent(){ try { const response = await fetch('/save-content', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ file_path: translationFilePath, content: translationEditor.value() }) }); const data = await response.json(); if (data.status !== 'success'){ console.error('保存失败:', data.message); } } catch (error){ console.error('保存错误:', error); } }
function setupKeyboardShortcuts(){ document.addEventListener('keydown',(e)=>{ if (e.ctrlKey && e.key === 's'){ e.preventDefault(); saveContent(); } }); }
window.addEventListener('DOMContentLoaded',()=>{ initEditors(); initResizer(); loadOriginalContent(); setupAutoSave(); setupKeyboardShortcuts(); document.getElementById('startTranslationBtn').addEventListener('click', startTranslation); document.getElementById('openOriginalBtn').addEventListener('click', () => openFile(originalFilePath)); document.getElementById('openTranslationBtn').addEventListener('click', () => openFile(translationFilePath)); const newFileBtn=document.getElementById('newFileBtn'); if (newFileBtn){ newFileBtn.addEventListener('click', async (e)=>{ e.preventDefault(); try { const res = await fetch('/get-latest-cache'); const data = await res.json(); const csvPath = (data && data.csv_path) ? data.csv_path : ''; const provider = (data && data.llm_provider) ? data.llm_provider : ''; await fetch('/prepare-editor', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ md_path:'', csv_path: csvPath, llm_provider: provider }) }); } catch (e){} window.location.href='/?from=newfile'; }); } });
